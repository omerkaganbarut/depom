#include <Arduino.h>
#include <SD.h>
#include "stepmotorenkoderiokuma.h"
#include "config.h"
#include "analogokuyucu.h"

// Step motor ve encoder nesneleri
StepMotorEncoder stepEnc1(ENC1_A_PIN, ENC1_B_PIN);
StepMotorEncoder omronEnc(OMRON_A_PIN, OMRON_B_PIN);
AnalogOkuyucu pot(A0, 0, 1023, 0.0f, 400.0f);

// --- Buffer tanÄ±mÄ± ---
#define BUFFER_BOYUTU  100  // Her seferinde 100 satÄ±rlÄ±k veri yazÄ±lacak
struct KAYIT_SATIRI {
  uint16_t pulseNo;
  int32_t enc1;
  int32_t omron;
  float potDegeri;
};
KAYIT_SATIRI buffer[BUFFER_BOYUTU];
uint16_t bufferIndex = 0;

// --- SD ve dosya oluÅŸturma fonksiyonu ---
File veriDosyasi;
String dosyaAdiOlustur() {
  for (int i = 1; i < 100; i++) {
    String ad = "veri" + String(i) + ".txt";
    if (!SD.exists(ad.c_str())) {
      return ad;
    }
  }
  return "veriSON.txt";
}

// --- Parametreler ---
const uint16_t MAX_PULSE = 10000; // 1 tur iÃ§in toplam pulse
const unsigned long TUR_SURE_MS = 20000; // 20 saniyede 1 tur
const float PULSE_FREQ = (float)MAX_PULSE / (TUR_SURE_MS / 1000.0f); // pulse/sn
const unsigned long PULSE_ARALIK_US = (1000000UL) / PULSE_FREQ; // mikro-saniye cinsinden
// PULSE_ARALIK_US her pulseâ€™Ä±n aralÄ±ÄŸÄ±, tam sabitlik iÃ§in micros kullanÄ±lacak

// --- Motor pulse ve sayaÃ§lar ---
uint16_t pulseSayaci = 0;
bool pulseHigh = false;
unsigned long pulseTimerUs = 0;

// --- Durum ---
bool bufferAktariliyor = false;

void setup() {
  Serial.begin(115200);

  pinMode(STEP1_PIN, OUTPUT);
  pinMode(DIR1_PIN, OUTPUT);
  pinMode(ENA1_PIN, OUTPUT);
  pinMode(ENA2_PIN, OUTPUT);
  digitalWrite(ENA1_PIN, LOW);   // SÃ¼rÃ¼cÃ¼ aktif
  digitalWrite(ENA2_PIN, HIGH); 
  digitalWrite(DIR1_PIN, HIGH);  // YÃ¶n

  stepEnc1.begin();
  omronEnc.begin();
  pot.baslat();

  if (!SD.begin(SD_CS_PIN)) {
    Serial.println("âŒ SD kart baÅŸlatÄ±lamadÄ±!");
    while (1);
  }

  String yeniDosya = dosyaAdiOlustur();
  veriDosyasi = SD.open(yeniDosya.c_str(), FILE_WRITE);
  if (!veriDosyasi) {
    Serial.print("âŒ ");
    Serial.print(yeniDosya);
    Serial.println(" dosyasÄ± aÃ§Ä±lamadÄ±!");
    while (1);
  }
  Serial.print("âœ… KayÄ±t dosyasÄ±: ");
  Serial.println(yeniDosya);

  // BaÅŸlÄ±k satÄ±rÄ±
  veriDosyasi.println("PULSE, ENC1, OMRON, POT");
  veriDosyasi.flush();

  Serial.print("Pulse frekansÄ±: ");
  Serial.print(PULSE_FREQ, 2);
  Serial.println(" Hz");
  Serial.println("âœ… KayÄ±t baÅŸlÄ±yor...");
  pulseTimerUs = micros();
}

void loop() {
  // EÄŸer buffer aktarÄ±lÄ±yor ise motoru beklet, SD'ye aktarÄ±m yapÄ±lÄ±r
  if (bufferAktariliyor) {
    for (uint16_t i = 0; i < BUFFER_BOYUTU; i++) {
      veriDosyasi.print(buffer[i].pulseNo);
      veriDosyasi.print(", ");
      veriDosyasi.print(buffer[i].enc1);
      veriDosyasi.print(", ");
      veriDosyasi.print(buffer[i].omron);
      veriDosyasi.print(", ");
      veriDosyasi.println(buffer[i].potDegeri, 2);
    }
    veriDosyasi.flush();
    bufferAktariliyor = false;
    bufferIndex = 0; // yeni buffer'a baÅŸlanacak

    Serial.println("ðŸŸ¢ 100'lÃ¼k veri buffer'Ä± SD'ye aktarÄ±ldÄ±!");
    // Burada motor beklemiÅŸti, ÅŸimdi devam edecek
  }

  // Pulse iÅŸlemleri (buffer aktarÄ±mÄ± sÄ±rasÄ±nda motor bekler)
  if (pulseSayaci < MAX_PULSE && !bufferAktariliyor) {
    unsigned long simdiUs = micros();
    if (!pulseHigh && (simdiUs - pulseTimerUs >= PULSE_ARALIK_US)) {
      // LOW â†’ HIGH geÃ§iÅŸi (pulse baÅŸla)
      digitalWrite(STEP1_PIN, HIGH);
      pulseHigh = true;
      pulseTimerUs = simdiUs;

      // --- VERÄ° OKU VE BUFFER'A YAZ ---
      pulseSayaci++;
      buffer[bufferIndex].pulseNo = pulseSayaci;
      buffer[bufferIndex].enc1 = stepEnc1.getPosition();
      buffer[bufferIndex].omron = omronEnc.getPosition();
      buffer[bufferIndex].potDegeri = pot.oku();

      bufferIndex++;

      // Seri ekrana Ã¶zet ver
      if (bufferIndex == 1 || bufferIndex == BUFFER_BOYUTU)
      {
        Serial.print("âœ” ");
        Serial.print(pulseSayaci);
        Serial.print(" | ENC1: ");
        Serial.print(buffer[bufferIndex-1].enc1);
        Serial.print(" | OMRON: ");
        Serial.print(buffer[bufferIndex-1].omron);
        Serial.print(" | POT: ");
        Serial.println(buffer[bufferIndex-1].potDegeri, 2);
      }

      // Buffer dolduysa, SD'ye aktarÄ±lacak, motor duracak
      if (bufferIndex >= BUFFER_BOYUTU) {
        bufferAktariliyor = true;
         // SÃ¼rÃ¼cÃ¼ disable â†’ motor durur
        digitalWrite(STEP1_PIN, LOW); // Pulse dÃ¼ÅŸÃ¼kte bÄ±rak
        pulseHigh = false;
        return;
      }
    }
    else if (pulseHigh && (simdiUs - pulseTimerUs >= 100)) { // Pulse geniÅŸliÄŸi min. 100us
      digitalWrite(STEP1_PIN, LOW);
      pulseHigh = false;
      pulseTimerUs = simdiUs;
    }
  }

  // TÃ¼m pulseâ€™lar tamamlandÄ±ysa, kalan buffer'Ä± yaz ve Ã§Ä±k
  if (pulseSayaci >= MAX_PULSE) {
    if (bufferIndex > 0) {
      for (uint16_t i = 0; i < bufferIndex; i++) {
        veriDosyasi.print(buffer[i].pulseNo);
        veriDosyasi.print(", ");
        veriDosyasi.print(buffer[i].enc1);
        veriDosyasi.print(", ");
        veriDosyasi.print(buffer[i].omron);
        veriDosyasi.print(", ");
        veriDosyasi.println(buffer[i].potDegeri, 2);
      }
      veriDosyasi.flush();
      Serial.println("ðŸŸ¢ Son kalan buffer da SD'ye aktarÄ±ldÄ±.");
    }
    digitalWrite(ENA1_PIN, HIGH);  // SÃ¼rÃ¼cÃ¼yÃ¼ kapat

    if (veriDosyasi) {
      veriDosyasi.close();
      Serial.println("âœ… Veri kaydÄ± tamamlandÄ±, dosya kapatÄ±ldÄ±.");
    }
    while (1);
  }
}