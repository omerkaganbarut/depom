#include <Arduino.h>
#include "config.h"
#include "stepmotorenkoderiokuma.h"

// Encoder nesneleri
StepMotorEncoder zEncoder(ENC1_A_PIN, ENC1_B_PIN);
StepMotorEncoder xEncoder(ENC2_A_PIN, ENC2_B_PIN);
StepMotorEncoder bigEncoder(ENC3_A_PIN, ENC3_B_PIN);

// Pulse zamanlayıcıları
unsigned long stepUsZ = 0, stepUsX = 0, stepUsBIG = 0;
const unsigned long pulseDelayUs = 1000;  // 1 kHz
const int pulseHighUs = 20;

bool zStepHigh = false, xStepHigh = false, bigStepHigh = false;

void setup() {
  Serial.begin(9600);

  // Motor pinleri
  pinMode(STEP1_PIN, OUTPUT); pinMode(DIR1_PIN, OUTPUT); pinMode(ENA1_PIN, OUTPUT);
  pinMode(STEP2_PIN, OUTPUT); pinMode(DIR2_PIN, OUTPUT); pinMode(ENA2_PIN, OUTPUT);
  pinMode(STEP3_PIN, OUTPUT); pinMode(DIR3_PIN, OUTPUT); pinMode(ENA3_PIN, OUTPUT);

  digitalWrite(ENA1_PIN, LOW);
  digitalWrite(ENA2_PIN, LOW);
  digitalWrite(ENA3_PIN, LOW);

  // Butonlar
  pinMode(PUSH1_PIN, INPUT_PULLUP); pinMode(TOGGLE1_PIN, INPUT_PULLUP);
  pinMode(PUSH2_PIN, INPUT_PULLUP); pinMode(TOGGLE2_PIN, INPUT_PULLUP);
  pinMode(PUSH3_PIN, INPUT_PULLUP); pinMode(TOGGLE3_PIN, INPUT_PULLUP);

  // Acil durdurma
  pinMode(EMERGENCY_STOP_PIN, INPUT_PULLUP);

  // Encoderleri başlat
  zEncoder.begin();
  xEncoder.begin();
  bigEncoder.begin();

  Serial.println(">> 3 MOTOR ENCODER KONTROLLÜ TEST BAŞLADI");
}

void loop() {
  unsigned long simdiUs = micros();
  unsigned long simdiMs = millis();

  // === ACİL STOP ===
  if (digitalRead(EMERGENCY_STOP_PIN) == LOW) {
    digitalWrite(STEP1_PIN, LOW);
    digitalWrite(STEP2_PIN, LOW);
    digitalWrite(STEP3_PIN, LOW);
    Serial.println("!!! ACİL STOP !!!");
    delay(300);
    return;
  }

  // === Z MOTOR ===
  if (digitalRead(PUSH1_PIN) == LOW) {
    digitalWrite(DIR1_PIN, digitalRead(TOGGLE1_PIN) ? HIGH : LOW);

    if (!zStepHigh && simdiUs - stepUsZ >= pulseDelayUs) {
      digitalWrite(STEP1_PIN, HIGH);
      zStepHigh = true;
      stepUsZ = simdiUs;
    }

    if (zStepHigh && simdiUs - stepUsZ >= pulseHighUs) {
      digitalWrite(STEP1_PIN, LOW);
      zStepHigh = false;
    }
  }

  // === X MOTOR ===
  if (digitalRead(PUSH2_PIN) == LOW) {
    digitalWrite(DIR2_PIN, digitalRead(TOGGLE2_PIN) ? HIGH : LOW);

    if (!xStepHigh && simdiUs - stepUsX >= pulseDelayUs) {
      digitalWrite(STEP2_PIN, HIGH);
      xStepHigh = true;
      stepUsX = simdiUs;
    }

    if (xStepHigh && simdiUs - stepUsX >= pulseHighUs) {
      digitalWrite(STEP2_PIN, LOW);
      xStepHigh = false;
    }
  }

  // === BIG MOTOR ===
  if (digitalRead(PUSH3_PIN) == LOW) {
    digitalWrite(DIR3_PIN, digitalRead(TOGGLE3_PIN) ? HIGH : LOW);

    if (!bigStepHigh && simdiUs - stepUsBIG >= pulseDelayUs) {
      digitalWrite(STEP3_PIN, HIGH);
      bigStepHigh = true;
      stepUsBIG = simdiUs;
    }

    if (bigStepHigh && simdiUs - stepUsBIG >= pulseHighUs) {
      digitalWrite(STEP3_PIN, LOW);
      bigStepHigh = false;
    }
  }

  // === ENCODER BİLGİLERİNİ YAZDIR ===
  static unsigned long printOnceki = 0;
  if (millis() - printOnceki >= 500) {
    printOnceki = millis();
    Serial.print("Z: "); Serial.print(zEncoder.getPosition());
    Serial.print(" | X: "); Serial.print(xEncoder.getPosition());
    Serial.print(" | BIG: "); Serial.println(bigEncoder.getPosition());
  }
}
